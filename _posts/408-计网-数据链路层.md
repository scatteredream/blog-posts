---
name: datalink-physics
title: 物理层&数据链路层
date: 2024-12-30
tags:
- 以太网
- CSMA/CD
- MAC
categories:
- 计网

---





# 物理层

[同轴电缆 - 维基百科，自由的百科全书](https://zh.wikipedia.org/wiki/同轴电缆) 

**单向通信**：Simplex，只有一个方向的通信，没有反向的交互。

**半双工**：Half-Duplex，可以收发信息，但无法同时收发。

**全双工**：Full-Duplex，可以同时收发信息。双工通信需要两条信道。

------

**基带信号**：基本频带信号，来自信源的信号。

**调制**：将基带信号做一定的转换，使之能够在信道内传输。

**基带调制**（编码）：将数字信号做一定转换，仍然是数字信号，但是更能适应信道特性。

**带通调制**：使用载波（Carrier）调制数字信号，搬到频率较高的频段，转成模拟信号，以便在模拟信道中传输。

------


**奈氏准则**：带宽W，则码元传输最高速率是2W/个每秒，超过则会出现严重的码间串扰。

**香农公式**：信噪比越大，带宽越高，极限传输速率越高。

------

**导引型传输媒体**：双绞线、同轴电缆、光缆。

**非导引型传输媒体**：无线电微波通信（蜂窝网）、短波通信、微波接力（卫星通信）。

------

**信道复用**：解决多节点接入同一信道的冲突问题，码分、时分、波分、频分、空分、正交。

------


**宽带接入**：ADSL、拨号上网(猫, modem)  HFC、FTTx（光纤到x，光猫, ONT）。

# 数据链路层（LAN）

## 数据链路层面对的三个问题

- **帧**（Frame）：用帧来封装分组交换的基本单位（IP数据报），限定IP数据报的长度（MTU），用特定字符（如SOH EOT）来作为帧与帧之间的界限。
- **透明传输**（Transparency）：也叫二进制安全（Binary-Safe），如果数据负载（Payload）中恰好出现了和界限字符二进制码相同的部分，则应该通过转义字符（ESC）加以区分。
- **差错检验**（Error Detection）：以帧为单位，使用循环冗余校验（Cyclic Redundancy Check）检查二进制比特是否传输错误（比特差错）有则丢弃数据帧，主要是帧内部的差错。
  - 可靠传输：链路层的发送端发什么，接收端就收到什么。（没有比特差错，也没有帧之间的差错）
  - 确认、重传机制：如果是可靠的信道（如有线链路）则不需要重传，如果是信道质量较差的无线链路传输，则有重传机制，也就是提供可靠的传输。

## 点对点信道

一对一，典型协议：PPP协议（宽带上网的PPPoE，用户和ISP之间连接）

## 广播信道

一对多，总线型拓扑以太网，典型协议：CSMA/CD (载波侦听多点接入/碰撞检测)

**共享信道**：

- 静态分配：FrequencyDM,CodeDM,WaveDM,TimeDM，对于局域网来说成本太高。

- 动态分配：
  - 随机接入：随时发送，碰撞导致传输率降低，CSMA/CD检测碰撞(IEEE 802.3 / DIX Ethernet V2)

  - 受控接入：令牌环局域网 (IEEE 802.5) 

**LLC**（Logical Link Control）：逻辑链路控制，早期有很多局域网标准，用LLC来标识使用哪一种标准，后来只剩以太网

**MAC**（Media Access Control）：媒体接入控制，控制传输媒体的层级。

### 适配器（Adapter）

硬件上也叫做网卡，ROM中存放MAC地址（硬件地址），承担着串行/并行信号的转换工作（作为内外信号的一个缓冲区）将IP数据报封装成帧发送出去，或是接收网帧并提供校验，通过则发给CPU开始IO，校验失败则丢弃网帧，超过也会丢弃。

### 以太网（Ethernet）

#### 以太网的两大特征

- 无连接：不必事先建立连接，不可靠，尽最大努力交付，是否需要重传完全依赖于高层的控制
- 曼彻斯特编码：方便接收方提取位同步信号，能够有效标示码元。

#### CSMA/CD

- MA（Multiple Access）： 多点接入 多台主机接入总线。
- CS（Carrier Sense）： 信道监听，边发送边监听信道的电压变化。
- CD（Collision Detection）：监听到别人发送了（检测到碰撞）就停止自己的发送，避免浪费网络资源。由于传播时延，导致真正碰撞发生一段时间，B才会检测到发生碰撞停止发送，再过一段时间等B传到A，A才会意识到发生碰撞了

##### 二进制指数退避(BEB)

Binary Exponential Backoff

二进制指数退避算法是一种网络协议中用于解决数据传输冲突的方法。在以太网的CSMA/CD协议中，当多个设备尝试同时发送数据时，可能会发生冲突。为了减少冲突的发生，二进制指数退避算法被用来计算设备在重传前应等待的时间。通过随机化退避时间，有效地减少了连续冲突的可能性。随着重传次数的增加，退避时间的上限也随之增加，这有助于在网络负载较重时平滑流量。然而，这种方法牺牲了时间效率，因为退避时间可能会指数增长，导致数据传输的延迟。此外，当退避时间达到一定阈值时，算法会停止增加退避时间，以避免无限制的延迟。

二进制指数退避算法的基本步骤如下：

1. 确定基本退避时间，通常设为一个争用期时间，例如以太网中为51.2微秒。
2. 定义重传次数K，取重传次数和10的较小值，即K=min(重传次数, 10)。
3. 从集合[0, 1, 2, ..., (2^K - 1)]中随机选择一个整数R。
4. 计算退避时间T，即T=R×基本退避时间。
5. 如果重传次数达到16次仍未成功，则放弃传输并报告给上层协议。

#### 总线型拓扑以太网

- 只能是半双工通信，适配器使用CSMA/CD协议

- 不能确定信道空闲后某一时间发送的帧一定不碰撞（发送的不确定性）

- 信道空闲一段时间（这段时间称为争用期/碰撞窗口 collision window）之后，才能保证发送的帧一定不碰撞，因此各站点需竞争

#### 基于集线器的星形拓扑以太网（10BASE-T）

- 使用双绞线 RJ-45 作为线缆和插头，使用集线器（hub）作为中心硬件

- 集线器内部仍然是用电子器件模拟实际电缆，实际上仍是总线型拓扑，适配器使用CSMA/CD协议

![7f194dec14ad2db7fe353c0893c1ad62](https://pub-9e727eae11e040a4aa2b1feedc2608d2.r2.dev/PicGo/7f194dec14ad2db7fe353c0893c1ad62-1732332398363-2.jpg)

#### 信道利用率

一个帧在发送之前必须经过若干个争用期2τ（发生碰撞），然后经过发送时延T~0~，再经历一个传播时延τ才能发到对面。发送过程占用总线的时间为T~0~ + τ
$$
a=\frac{\tau}{T_0}
$$
因为传播时延τ的存在，碰撞之后不能立即检测到，造成了信道浪费，所以比值a越小越好，也就是连线尽量短一些，控制以太网帧长度不能太短（大于64字节）也不能太长（小于1518字节，MTU + 其他标识位）

### 以太网帧

#### MAC地址

以太网的MAC地址为48位二进制数，有两个保留的标识位G/L与I/G，一共能表示2^46^个不同的地址，和网卡绑定在一起，存在网卡的ROM中，例：E4-FD-45-3E-4A-A4

#### 以太网帧、MAC帧格式（DIX Ethernet V2）

[以太网帧格式 - 维基百科，自由的百科全书](https://zh.wikipedia.org/wiki/以太网帧格式#Ethernet_II) 

![8639303972e62f982d1666dffca21057](https://pub-9e727eae11e040a4aa2b1feedc2608d2.r2.dev/PicGo/8639303972e62f982d1666dffca21057.jpg)

- 前方7B是同步字段，告诉网卡调整时钟和发送端同步，最后1B也是同步段，11表示之后才是真正的以太网帧。

- 接下来的12B是**目标地址**和**源地址**，目标地址在前方便检查是不是发给自己的。

- **类型**占2B，用来区分数据负载[以太类型](https://zh.wikipedia.org/wiki/以太类型)的字段ARP、IPv4等
- **数据负载**部分，长度最小为46B（整个以太网帧不能小于64B，否则CSMA/CD不能正常工作，还有好处就是提高了帧的传输效率(有效部分占的bi'lv)），最大为MTU(1500B，太长会导致发送与转发负担太重，一点小差错就要重传，反而降低了效率)
- **FCS**（帧校验序列）长度为固定4B，FCS不检测前8B的同步字段。
- 以太网帧有效长度 64B-1518B
- 有帧开始定界符，没有帧结束符或者长度。因为以太网使用曼彻斯特编码，因此只需要在帧之间留出一定空隙即可，检测到空隙则表示帧的结束。

## 物理层扩展以太网

- **转发器**（repeater）：也叫中继器，早先通过其扩大局域网的物理范围

- **集线器**：将主机用光纤加一个modem与**集线器**（hub）连接起来，再用一个集线器分别连接几个集线器，这样做比较简单，但是系统总吞吐量有严重的木桶效应，hub也不能缓存网帧，比较低效。

![2d8d54ff5a6ea450f7378124fb8cf209](https://pub-9e727eae11e040a4aa2b1feedc2608d2.r2.dev/PicGo/2d8d54ff5a6ea450f7378124fb8cf209-1732358355703-4.jpg)

## 数据链路层扩展以太网

### 网桥（bridge）

使用软件，根据目的地址转发和过滤帧，维护一个地址表来确定具体的转发目标。能够隔离碰撞域

### 交换机（switch）

- 实质是多端口网桥，能够支持并行通信，并且有专门的硬件芯片用来转发过滤，比网桥快很多。

- 每个端口之间都是独占传输域，能够进行全双工通信（也就不用遵守CSMA/CD）总吞吐量没有木桶效应。

- 端口有存储器，能在繁忙时将网帧暂存。支持存储转发和直通（cut-through）多种方式，减小交换时延。

- 凭借**自学习**功能维护一个地址表（交换表），根据发出网帧的源MAC地址，将端口映射到MAC地址。

#### 自学习

省去了人工配置的麻烦，即插即用


  - 一开始地址表为空，交换机通过MAC地址的源地址部分，确定A地址对应端口1，填到地址表中

  - 不知道目标B地址的端口，因此采用**广播帧**的形式，其他网卡收到帧，发现目标地址不是自己，遂直接丢弃

  - B收到网帧，发现是发给自己的，收下。B再发出网帧到A，因此地址表中添加了B地址对应端口2的记录

  - 下次有人想发给A或者B，直接按照地址表转发到对应端口就可以，不用再次**广播**

  - 弊端：广播帧可能会导致频繁的端口之间转发，消耗了很多没有必要消耗的网络资源（广播风暴）

### 虚拟局域网（Virtual Local Area Network, VLAN）

[IEEE 802.1Q封装的VLAN数据帧格式 - 华为](https://support.huawei.com/enterprise/zh/doc/EDOC1100088136) 

- 将一个大局域网（广播域）分成几个小的局域网，减少网络风暴的发生，并且能提高局域网内的私密性、安全性。

- IEEE 802.1Q帧在原先的MAC帧的源地址后、类型字段前添加了VLAN字段，用于不同交换机之间的传输：


![77e8ffb822418303da48f04e1094c8a4](https://pub-9e727eae11e040a4aa2b1feedc2608d2.r2.dev/PicGo/77e8ffb822418303da48f04e1094c8a4.jpg)

- 在两台交换机之间能够组出很多个(4096)不同的网络（VLAN）如果发送目标横跨交换机，则交换机1会发送IEEE 802.1Q帧，再由交换机2将标签去掉把原先的MAC帧传给目标。


![359e5dc70c67ed8789ffb347a4237c7f](https://pub-9e727eae11e040a4aa2b1feedc2608d2.r2.dev/PicGo/359e5dc70c67ed8789ffb347a4237c7f.jpg)

- 对于A与C的通信，他们不属于同一个局域网，因此不是数据链路层所能解决的，需要路由器（当然有的交换机也有附加的功能，称为L3/L2 switch，与L2 switch相对）

## 以太网的宽带接入（PPPoE）

- ADSL、拨号上网需要猫（调制解调器，modem）负责模拟信号和数字信号的转换
- 如果是光纤到户FTTH需要光猫（光纤网络终端，Optical Network Terminal）负责光信号与数字信号的转换
- FTTB，FTTF则连光猫也不需要了

# 无线网络

## 无线网络与以太网

**物理介质：**

- **无线网络 (Wi-Fi 和蜂窝移动网络)**：使用无线电波或微波作为通信介质，无需物理线缆。
- **以太网 (Ethernet)**：使用有线连接（如双绞线、光纤）作为通信介质，需要物理布线。

**标准协议：**

- **无线网络**：
  - **Wi-Fi (802.11 系列)**：基于 IEEE 802.11 协议，适用于局域网 (WLAN)。
  - **蜂窝移动网络**：包括 2G、3G、4G、5G，主要用于广域网 (WAN)。
- **以太网**：基于 IEEE 802.3 协议，主要应用于局域网 (LAN)。

**覆盖范围：**

- **无线网络**：
  - Wi-Fi 的典型覆盖范围是几十米，适合室内使用。
  - 蜂窝网络覆盖范围更广，可以跨城市、国家甚至全球。
- **以太网**：
  - 受限于线缆长度，一般在100米以内，需要交换机或路由器扩展覆盖范围。

**传输速度：**

- **无线网络**：
  - Wi-Fi 6（802.11ax）理论速度可达 9.6 Gbps。
  - 蜂窝网络的 5G 技术最高速度可达 10 Gbps。
- **以太网**：
  - 常见的千兆以太网 (1 Gbps) 和万兆以太网 (10 Gbps) 具有更稳定的高速连接。

**移动性：**

- **无线网络**：用户可以自由移动而不影响网络连接，尤其是蜂窝网络支持无缝切换。
- **以太网**：由于需要有线连接，设备的移动性受到限制。

**安全性：**

- **无线网络**：容易受到信号干扰和窃听攻击，需要依赖加密协议（如 WPA3）增强安全性。
- **以太网**：由于是物理连接，安全性相对较高，受到外部攻击的风险较低。

## 碰撞协议

### CSMA/CA: **Collision Avoidance** (WLAN)

- **机制**：
  1. **监听信道**：设备在发送数据前先监听信道是否空闲。
  2. **等待随机时间 (Backoff)**：即使信道空闲，设备也会等待一段随机时间，以减少多个设备同时发送的概率。
  3. **发送 RTS/CTS (可选)**：使用请求发送 (RTS) 和清除发送 (CTS) 控制帧来保留信道，避免隐藏节点问题。其他节点在监听到 RTS 或 CTS 时暂停发送数据，从而减少冲突风险。
  4. **确认 (ACK)**：接收端发送确认帧，确保数据成功接收。如果未收到确认，则重新发送数据。

- **优点**：
  1. 避免了碰撞的直接发生，适合共享信道的无线环境。
  2. RTS/CTS 机制解决隐藏节点问题，减少冲突概率。

- **缺点**：

  1. 增加额外的通信开销（RTS、CTS 和 ACK 等控制帧）。

  2. 多用户高并发时容易导致延迟增加和吞吐量下降。

### CSMA/CD: **Collision Detection** (**Ethernet**)

- **机制**：

  1. **监听信道**：设备在发送数据前检测信道是否空闲。
  2. **发送数据**：如果信道空闲，立即发送数据。
  3. **检测碰撞**：发送时同时监听信道，如果检测到冲突（信号干扰或能量变化），停止发送。
  4. **退避 (Backoff)**：碰撞后等待随机时间重试发送（BEB），减少再次碰撞概率。

  - **现代以太网多采用交换机连接，并支持全双工通信，每个设备有独立信道，不再使用 CSMA/CD。无碰撞问题，提高效率和可靠性。支持更高的带宽和多设备并发通信。**

- 优点：

  1. 机制简单，适合有线环境。
  2. 在小型局域网中具有较高效率。

- 缺点：

  1. 需要碰撞发生后才能检测和处理，效率相对低于 CSMA/CA。
  2. 在高负载环境下碰撞频率增加，导致性能下降。

### CSMA/CA vs. CSMA/CD

| 协议        | 解决冲突方式        | 使用环境             | 特点                       |
| ----------- | ------------------- | -------------------- | -------------------------- |
| **CSMA/CD** | 冲突检测 + 重传     | 有线网络（如以太网） | 高速、低延迟               |
| **CSMA/CA** | 冲突避免 + 请求确认 | 无线网络（如Wi-Fi）  | 更安全、适合无线不稳定环境 |

- **CSMA/CD** 适合**有线网络**，由于信道稳定，可以边发送边检测冲突并重试。
- **CSMA/CA** 适合**无线网络**，因为无线信号不稳定，通过握手机制降低冲突发生的概率。

| 特性                 | **CSMA/CD**                                  | **CSMA/CA**                                  |
| -------------------- | -------------------------------------------- | -------------------------------------------- |
| **应用场景**         | 有线网络（以太网, 802.3）                    | 无线网络（如 Wi-Fi/802.11）                  |
| **冲突处理机制**     | 冲突检测（Collision Detection）              | 冲突避免（Collision Avoidance）              |
| **数据发送机制**     | 先发送数据，边发送边检测冲突。               | 发送前通过 RTS/CTS 机制避免冲突。            |
| **检测方式**         | 可通过检测电压变化检测冲突（有线信号明显）。 | 无法检测冲突（无线信号难以同时发送和接收）。 |
| **解决冲突方法**     | 冲突发生后停止发送，退避后重试。             | 通过等待时间和握手机制减少冲突。             |
| **适用介质**         | 有线介质，信号传播稳定。                     | 无线介质，信号传播容易受到干扰。             |
| **性能**             | 高速、低延迟，适合稳定传输环境。             | 延迟较高，适合信号不稳定的环境。             |
| **是否完全避免碰撞** | 碰撞不可避免，需通过重传恢复                 | 理论上可以避免，但控制开销较大               |
| **现代改进**         | 使用交换机+全双工，完全避免碰撞              | 保留 CSMA/CA，适合无线共享环境               |

## WPAN

**WPAN（Wireless Personal Area Network，无线个人区域网络）** 是一种覆盖范围较小的无线网络技术，通常用于个人设备之间的短距离通信

**1. 定义与特点**

**定义：**WPAN 是一种用于设备之间**短距离无线通信**的网络技术，支持个人或便携式设备的互联互通，例如手机、笔记本电脑、无线耳机等。

**特点：**

- **覆盖范围小：** 通常在 **10米** 左右，有些技术最多支持 **100米**。
- **低功耗：** 适合便携式设备使用，续航时间长。
- **高便携性：** 支持移动设备随时建立网络。
- **点对点通信：** 支持多种设备直接连接，无需复杂的基础设施。
- **成本低廉：** 适合小型设备和物联网应用。

**2. 常见-协议与标准**

| 协议/标准                          | 描述                                                     | 应用场景                             | 防碰撞协议          |
| ---------------------------------- | -------------------------------------------------------- | ------------------------------------ | ------------------- |
| **Bluetooth**                      | 短距离无线通信标准，覆盖范围约 10 米，低功耗版本为 BLE。 | 无线耳机、键盘、鼠标、传感器设备等。 | **FHSS** 和 **AFH** |
| **ZigBee**                         | 专为低功耗和低数据速率设计的无线标准，适合物联网应用。   | 智能家居、远程控制、传感器网络。     | **CSMA/CA**         |
| **Infrared (IR)**                  | 基于红外线通信的短距离无线技术，传输速率较低。           | 遥控器、数据同步、设备控制。         | **TDMA**            |
| **UWB (Ultra-Wideband)**           | 提供高精度定位和高速传输，适合短距离数据交换和测距应用。 | 精准定位、物联网设备、车联网通信。   |                     |
| **NFC (Near Field Communication)** | 超短距离无线通信，通常在几厘米范围内进行快速数据交换。   | 移动支付、门禁卡、电子票务。         | **TDMA**            |

小型无线设备（如 RFID）采用 **Slotted ALOHA**，适合简单需求。

**3. 应用场景**

1. **智能家居：** ZigBee 协议用于灯光控制、温度调节等智能设备之间的互联。
2. **物联网（IoT）：** BLE 和 ZigBee 支持低功耗设备之间的数据采集与传输。
3. **移动支付：** NFC 支持手机支付、身份识别等功能。
4. **便携设备互联：** Bluetooth 用于耳机、智能手表等无线连接。
5. **健康监测：** 无线传感器与可穿戴设备之间的数据交互。
6. **精准定位：** UWB 支持室内定位和安全设备跟踪。

**4. 与其他-网络的比较**

| 类型     | 范围               | 特点                                         | 示例                  |
| -------- | ------------------ | -------------------------------------------- | --------------------- |
| **WPAN** | 1-10 米            | 短距离、低功耗、适合个人设备通信。           | 蓝牙、ZigBee、NFC。   |
| **WLAN** | 10-100 米          | 支持中等距离的高速无线通信，需要基础设施。   | Wi-Fi。               |
| **WMAN** | 1-10 千米          | 城域无线网络，适合大规模覆盖。               | WiMAX。               |
| **WWAN** | 覆盖整个地区或国家 | 广域无线网络，通过蜂窝网络支持移动设备通信。 | 4G、5G 移动通信网络。 |

## 移动网络

CSMA/CA 和 CSMA/CD 是分布式介质访问控制协议，属于动态划分信道

- 竞争式访问（监听信道）：**CSMA** 并不通过物理上的分离信道来避免冲突，而是让多个用户共享同一个信道。因此会有冲突的风险。当信道繁忙时，用户需要监听并等待信道空闲才能发送数据。信道的访问是竞争式的，用户依赖于监听信道的状态来判断是否发送数据。

- 适合短距离、设备数量较少的环境，如家庭或办公室的无线网络
- 通信节点之间自主决定发送时机，不需要集中式调度。
- 采用竞争机制，存在碰撞和重传开销，效率较低，不适合大规模、高负载的网络环境。

蜂窝网络：

- CDMA TDMA FDMA 这些 MA 技术通过时间、频率、伪随机码等方式将信道划分为多个独立的信道，每个用户独占属于自己的信道，属于静态划分信道

- **蜂窝网络的流量远高于局域网（如 Wi-Fi）**，需要更高的效率和更严格的资源调度
- 采用集中式的**基站控制**，具有严格的调度和资源分配机制。
- 需要支持**用户移动性**，并保证跨基站切换过程的无缝通信。
- 需要满足严格的**服务质量（QoS）**要求，例如语音通话和视频流的低延迟、高可靠性。

| 技术              | 工作方式               | 应用场景                            | 主要特点                               |
| ----------------- | ---------------------- | ----------------------------------- | -------------------------------------- |
| **ALOHA**         | 随机发送，碰撞后重传   | 低负载无线通信                      | 简单但碰撞率高，适合控制信令。         |
| **Slotted ALOHA** | 分时发送，减少碰撞     | 控制信道接入（如 GSM 控制信道）RFID | 效率较高，但需要时钟同步。             |
| **TDMA**          | 固定时隙分配，无碰撞   | GSM、低速蜂窝网络                   | 高效，但资源利用率依赖时隙分配。       |
| **FDMA**          | 频率划分，无碰撞       | 早期模拟蜂窝和2G网络                | 固定频率分配，利用率低。               |
| **CDMA**          | 扩频码区分用户，无碰撞 | 3G 网络、CDMA2000                   | 无需时隙和频率划分，抗干扰能力强。     |
| **OFDMA**         | 子载波分配，无碰撞     | 4G LTE 和 5G NR                     | 支持多用户，频谱利用率高，适合高负载。 |